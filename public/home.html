<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Ordini - Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div style="position: absolute; top: 20px; right: 20px; z-index: 1000;">
        <!-- Pulsante abbonamenti temporaneamente nascosto -->
        <!-- <button onclick="window.location.href='subscription.html'" style="padding: 8px 16px; background: linear-gradient(135deg, #28a745, #20c997); margin-right: 10px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; transition: transform 0.2s, box-shadow 0.2s;">‚≠ê Abbonamenti</button> -->
        <button onclick="window.location.href='index.html'" style="padding: 8px 16px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; transition: transform 0.2s, box-shadow 0.2s;">üö™ Esci</button>
    </div>

    <div class="container home-container">
        <div class="header">
            <div class="logo-container" style="margin-bottom: 20px;">
                <img src="" alt=" Logo" style="width: 120px; height: auto; max-width: 100%;">


        <div class="company-info">
            <h2 id="company-display"> <span id="company-name"></span></h2>
        </div>

        <div class="button-grid">
            <a href="cucina.html" class="nav-button cucina">
                üç≥ Cucina
            </a>
            <a href="pizzeria.html" class="nav-button pizzeria">
                üçï Pizzeria
            </a>
            <a href="insalata.html" class="nav-button insalata">
                ü•ó Insalata
            </a>
            <a href="sala.html" class="nav-button sala">
                üçΩÔ∏è Sala
            </a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Helper function for Google Sign-In (if needed)
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                return result.user;
            } catch (error) {
                console.error('Errore Google Sign-In:', error);
                throw error;
            }
        }

        // Debug: Verifica localStorage all'avvio
        console.log('üîç DEBUG HOME - localStorage userCompany:', localStorage.getItem('userCompany'));

        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDZ0FdjenO-ngblcuXKdwWwvRV5liiR18I",
            authDomain: "app-dati-tavoli.firebaseapp.com",
            projectId: "app-dati-tavoli",
            storageBucket: "app-dati-tavoli.appspot.com",
            messagingSenderId: "267339065819",
            appId: "1:267339065819:web:1e74647f740bdf1d725ffe",
            measurementId: "G-F79QERTN6C"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Nascondi temporaneamente i pulsanti finch√© non √® caricato tutto
        const buttonGrid = document.querySelector('.button-grid');
        if (buttonGrid) {
            buttonGrid.style.opacity = '0.3';
            buttonGrid.style.pointerEvents = 'none';
        }

        // Mostra un indicatore di caricamento
        const loadingIndicator = document.createElement('div');
        loadingIndicator.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 9999; font-size: 16px; text-align: center;';
        loadingIndicator.innerHTML = '‚è≥ Caricamento...';
        document.body.appendChild(loadingIndicator);

        // Timeout di sicurezza aumentato: riabilita i pulsanti dopo 5 secondi in ogni caso
        setTimeout(() => {
            if (buttonGrid && buttonGrid.style.opacity !== '1') {
                console.warn('‚ö†Ô∏è Timeout raggiunto, riabilitazione forzata pulsanti');
                buttonGrid.style.opacity = '1';
                buttonGrid.style.pointerEvents = 'auto';
                if (loadingIndicator && loadingIndicator.parentNode) {
                    loadingIndicator.remove();
                }
            }
        }, 5000);

        // Flag per prevenire redirect multipli
        let authCheckComplete = false;
        let redirectTimeout = null;

        // Gestione autenticazione e dati utente
        onAuthStateChanged(auth, async (user) => {
            // Previeni controlli multipli
            if (authCheckComplete) {
                console.log('‚ö†Ô∏è Auth check gi√† completato, ignoro callback successivo');
                return;
            }

            console.log('üîç Auth check - User:', user ? user.email : 'null');

            if (user) {
                // Cancella qualsiasi timeout di redirect pendente
                if (redirectTimeout) {
                    clearTimeout(redirectTimeout);
                    redirectTimeout = null;
                }

                authCheckComplete = true;
                const userDocRef = doc(db, "users", user.uid);
                try {
                    const userDoc = await getDoc(userDocRef);
                    let userData = null;

                    if (userDoc.exists()) {
                        userData = userDoc.data();
                        console.log('‚úÖ Dati utente caricati:', userData);

                        // Mostra il nome utente
                        if (document.getElementById('user-display-name')) {
                            document.getElementById('user-display-name').textContent = `${userData.firstName} ${userData.lastName}`;
                        }

                        // IMPORTANTE: Forza il salvataggio del nome azienda nel localStorage se presente (normalizzato)
                        if (userData.company && userData.company.trim() !== '') {
                            const normalizedCompany = userData.company.trim().toLowerCase();
                            localStorage.setItem('userCompany', normalizedCompany);
                            console.log('‚úÖ Nome azienda aggiornato nel localStorage (normalizzato):', normalizedCompany);

                            // Aggiorna il nome dell'azienda nell'interfaccia
                            if (document.getElementById('company-name')) {
                                document.getElementById('company-name').textContent = userData.company.trim();
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Nessun nome azienda nel profilo Firestore');
                            // Usa il nome utente come fallback (normalizzato)
                            const fallbackName = `${userData.firstName} ${userData.lastName}`.trim().toLowerCase();
                            localStorage.setItem('userCompany', fallbackName);
                            console.log('‚úÖ Usato nome utente come fallback (normalizzato):', fallbackName);
                            if (document.getElementById('company-name')) {
                                document.getElementById('company-name').textContent = fallbackName;
                            }
                        }

                        // Aggiorna l'interfaccia dopo aver impostato il nome azienda
                        updateCompanyName();

                        // Rimuovi l'indicatore di caricamento
                        setTimeout(() => {
                            if (loadingIndicator && loadingIndicator.parentNode) {
                                loadingIndicator.remove();
                            }

                            // Riabilita i pulsanti dopo il caricamento con animazione fluida
                            if (buttonGrid) {
                                buttonGrid.style.transition = 'opacity 0.3s ease';
                                buttonGrid.style.opacity = '1';
                                buttonGrid.style.pointerEvents = 'auto';
                            }
                        }, 100);
                    } else {
                        console.error('‚ùå Documento utente non trovato');
                        loadingIndicator.remove();
                        alert('Errore: profilo utente non trovato. Contatta il supporto.');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    }
                } catch (error) {
                    console.error("‚ùå Errore nel recupero dei dati utente:", error);
                    
                    // Rimuovi loading indicator
                    if (loadingIndicator && loadingIndicator.parentNode) {
                        loadingIndicator.remove();
                    }
                    
                    // Riabilita comunque i pulsanti per permettere navigazione
                    if (buttonGrid) {
                        buttonGrid.style.opacity = '1';
                        buttonGrid.style.pointerEvents = 'auto';
                    }
                    
                    // NON reindirizzare per errori di rete o temporanei
                    if (error.code && error.code !== 'auth/network-request-failed' && error.code !== 'unavailable') {
                        console.warn('‚ö†Ô∏è Errore recupero dati, ma permetto navigazione');
                    }
                }
            } else {
                // L'utente non √® autenticato
                console.log('‚ö†Ô∏è Utente non autenticato rilevato');
                
                // Aspetta 2 secondi prima di reindirizzare per dare tempo a Firebase di completare l'autenticazione
                redirectTimeout = setTimeout(() => {
                    if (!authCheckComplete) {
                        console.log('‚ùå Timeout raggiunto senza autenticazione, reindirizzamento al login');
                        authCheckComplete = true;
                        
                        if (loadingIndicator && loadingIndicator.parentNode) {
                            loadingIndicator.remove();
                        }
                        
                        // Riabilita i pulsanti comunque (per evitare che restino bloccati)
                        if (buttonGrid) {
                            buttonGrid.style.opacity = '1';
                            buttonGrid.style.pointerEvents = 'auto';
                        }
                        
                        window.location.href = 'index.html';
                    }
                }, 2000);
            }
        });

        // Funzione per andare al login
        function goToLogin() {
            window.location.href = 'index.html';
        }

        // Gestione del nome dell'azienda
        document.addEventListener('DOMContentLoaded', function() {
            function updateCompanyName() {
                const companyName = localStorage.getItem('userCompany');
                const companyElement = document.getElementById('company-name');

                if (companyElement) {
                    if (companyName && companyName.trim() !== '') {
                        companyElement.textContent = companyName;
                    } else {
                        // Mostra un messaggio temporaneo mentre i dati vengono caricati
                        companyElement.textContent = 'Caricamento...';
                    }
                }

                console.log('Nome azienda dal localStorage:', companyName);
            }

            // Aggiorna immediatamente
            updateCompanyName();

            // Ascolta i cambiamenti nel localStorage
            window.addEventListener('storage', function(e) {
                if (e.key === 'userCompany') {
                    console.log('Storage event detected for userCompany:', e.newValue);
                    updateCompanyName();
                }
            });
        });

        // Funzione per impostare manualmente il nome dell'azienda (per test)
        function setCompanyName(name) {
            localStorage.setItem('userCompany', name);
            const companyElement = document.getElementById('company-name');
            if (companyElement) {
                companyElement.textContent = name;
            }
            console.log('Nome azienda impostato manualmente:', name);
        }
    </script>
</body>
</html>