<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Ordini - Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div style="position: absolute; top: 20px; right: 20px; z-index: 1000;">
        <!-- Pulsante abbonamenti temporaneamente nascosto -->
        <!-- <button onclick="window.location.href='subscription.html'" style="padding: 8px 16px; background: linear-gradient(135deg, #28a745, #20c997); margin-right: 10px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; transition: transform 0.2s, box-shadow 0.2s;">‚≠ê Abbonamenti</button> -->
        <button onclick="window.location.href='index.html'" style="padding: 8px 16px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; transition: transform 0.2s, box-shadow 0.2s;">üö™ Esci</button>
    </div>

    <div class="container home-container">
        <div class="header">
            <div class="logo-container" style="margin-bottom: 20px;">
                <img src="" alt=" Logo" style="width: 120px; height: auto; max-width: 100%;">


        <div class="company-info">
            <h2 id="company-display"> <span id="company-name"></span></h2>
        </div>

        <div class="button-grid">
            <a href="cucina.html" class="nav-button cucina">
                üç≥ Cucina
            </a>
            <a href="pizzeria.html" class="nav-button pizzeria">
                üçï Pizzeria
            </a>
            <a href="insalata.html" class="nav-button insalata">
                ü•ó Insalata
            </a>
            <a href="sala.html" class="nav-button sala">
                üçΩÔ∏è Sala
            </a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Debug: Verifica localStorage all'avvio
        console.log('üîç DEBUG HOME - localStorage userCompany:', localStorage.getItem('userCompany'));

        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Gestione autenticazione e dati utente
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                try {
                    const userDoc = await getDoc(userDocRef);
                    let userData = null;

                    if (userDoc.exists()) {
                        userData = userDoc.data();
                        console.log('Dati utente caricati:', userData);

                        // Mostra il nome utente
                        if (document.getElementById('user-display-name')) {
                            document.getElementById('user-display-name').textContent = `${userData.firstName} ${userData.lastName}`;
                        }

                        // IMPORTANTE: Forza il salvataggio del nome azienda nel localStorage se presente
                        if (userData.company && userData.company.trim() !== '') {
                            localStorage.setItem('userCompany', userData.company.trim());
                            console.log('‚úÖ Nome azienda aggiornato nel localStorage:', userData.company.trim());

                            // Aggiorna il nome dell'azienda nell'interfaccia
                            if (document.getElementById('company-name')) {
                                document.getElementById('company-name').textContent = userData.company.trim();
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Nessun nome azienda nel profilo Firestore');
                            // Usa il nome utente come fallback
                            const fallbackName = `${userData.firstName} ${userData.lastName}`;
                            localStorage.setItem('userCompany', fallbackName);
                            console.log('‚úÖ Usato nome utente come fallback:', fallbackName);
                            if (document.getElementById('company-name')) {
                                document.getElementById('company-name').textContent = fallbackName;
                            }
                        }

                        // Aggiorna l'interfaccia dopo aver impostato il nome azienda
                        updateCompanyName();
                    } else {
                        console.error('Documento utente non trovato');
                        // Non reindirizzare automaticamente - dai il tempo all'utente di vedere l'errore
                        alert('Errore: profilo utente non trovato. Contatta il supporto.');
                    }
                } catch (error) {
                    console.error("Errore nel recupero dei dati utente:", error);
                    // Non reindirizzare automaticamente in caso di errore temporaneo
                    alert('Errore temporaneo nel caricamento dei dati. Riprova.');
                }
            } else {
                // L'utente non √® autenticato, reindirizza al login
                console.log('‚ùå Utente non autenticato, reindirizzamento al login');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        });

        // Funzione per andare al login
        function goToLogin() {
            window.location.href = 'index.html';
        }

        // Gestione del nome dell'azienda
        document.addEventListener('DOMContentLoaded', function() {
            function updateCompanyName() {
                const companyName = localStorage.getItem('userCompany');
                const companyElement = document.getElementById('company-name');

                if (companyElement) {
                    if (companyName && companyName.trim() !== '') {
                        companyElement.textContent = companyName;
                    } else {
                        // Mostra un messaggio temporaneo mentre i dati vengono caricati
                        companyElement.textContent = 'Caricamento...';
                    }
                }

                console.log('Nome azienda dal localStorage:', companyName);
            }

            // Aggiorna immediatamente
            updateCompanyName();

            // Ascolta i cambiamenti nel localStorage
            window.addEventListener('storage', function(e) {
                if (e.key === 'userCompany') {
                    console.log('Storage event detected for userCompany:', e.newValue);
                    updateCompanyName();
                }
            });
        });

        // Funzione per impostare manualmente il nome dell'azienda (per test)
        function setCompanyName(name) {
            localStorage.setItem('userCompany', name);
            const companyElement = document.getElementById('company-name');
            if (companyElement) {
                companyElement.textContent = name;
            }
            console.log('Nome azienda impostato manualmente:', name);
        }
    </script>
</body>
</html>