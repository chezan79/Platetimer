
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reimposta Password</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h2>Reimposta Password</h2>
            <div id="reset-message" class="message"></div>
            
            <div id="reset-form">
                <form id="form-password-reset">
                    <input type="password" id="new-password" placeholder="Nuova Password" required>
                    <input type="password" id="confirm-new-password" placeholder="Conferma Nuova Password" required>
                    <button type="submit">Reimposta Password</button>
                </form>
            </div>
            
            <div class="toggle-link">
                <span><a href="index.html">Torna al Login</a></span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, confirmPasswordReset, verifyPasswordResetCode } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDZ0FdjenO-ngblcuXKdwWwvRV5liiR18I",
            authDomain: "app-dati-tavoli.firebaseapp.com",
            projectId: "app-dati-tavoli",
            storageBucket: "app-dati-tavoli.appspot.com",
            messagingSenderId: "267339065819",
            appId: "1:267339065819:web:1e74647f740bdf1d725ffe",
            measurementId: "G-F79QERTN6C"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Funzione per mostrare messaggi
        function showMessage(elementId, message, isError = false) {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            messageEl.className = `message ${isError ? 'error' : 'success'}`;
        }

        // Ottieni i parametri dall'URL
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const oobCode = urlParams.get('oobCode');

        if (mode === 'resetPassword' && oobCode) {
            // Verifica il codice di reset
            verifyPasswordResetCode(auth, oobCode)
                .then((email) => {
                    showMessage('reset-message', `Reimposta la password per: ${email}`, false);
                })
                .catch((error) => {
                    showMessage('reset-message', 'Link di reset non valido o scaduto', true);
                    document.getElementById('reset-form').style.display = 'none';
                });

            // Gestisci il form di reset
            document.getElementById('form-password-reset').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;

                if (newPassword !== confirmPassword) {
                    showMessage('reset-message', 'Le password non coincidono', true);
                    return;
                }

                if (newPassword.length < 6) {
                    showMessage('reset-message', 'La password deve essere di almeno 6 caratteri', true);
                    return;
                }

                try {
                    await confirmPasswordReset(auth, oobCode, newPassword);
                    showMessage('reset-message', 'Password reimpostata con successo! Reindirizzamento al login...', false);
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } catch (error) {
                    let errorMessage = 'Errore durante la reimpostazione della password';
                    
                    switch (error.code) {
                        case 'auth/weak-password':
                            errorMessage = 'La password è troppo debole';
                            break;
                        case 'auth/expired-action-code':
                            errorMessage = 'Il link di reset è scaduto';
                            break;
                        case 'auth/invalid-action-code':
                            errorMessage = 'Il link di reset non è valido';
                            break;
                    }
                    
                    showMessage('reset-message', errorMessage, true);
                }
            });
        } else {
            showMessage('reset-message', 'Link di reset non valido', true);
            document.getElementById('reset-form').style.display = 'none';
        }
    </script>
</body>
</html>
