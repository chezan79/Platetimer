<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cucina - Voice Call System</title>
    <link rel="stylesheet" href="css/call-interface.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-utensils"></i> Cucina</h1>
            <p class="subtitle">Kitchen Communication System</p>
        </header>

        <div class="call-interface">
            <div class="status-section">
                <div class="status-indicator" id="connectionStatus">
                    <i class="fas fa-circle"></i>
                    <span id="statusText">Disconnected</span>
                </div>
                <div class="call-status" id="callStatus">Ready to call</div>
            </div>

            <div class="controls-section">
                <button id="callButton" class="btn btn-call" onclick="window.initiateCall ? window.initiateCall() : fallbackInitiateCall()">
                    <i class="fas fa-phone"></i>
                    Call Pizzeria
                </button>

                <button id="hangupButton" class="btn btn-hangup" onclick="window.endCall ? window.endCall() : fallbackEndCall()" disabled>
                    <i class="fas fa-phone-slash"></i>
                    End Call
                </button>

                <button id="muteButton" class="btn btn-mute" onclick="window.toggleMute ? window.toggleMute() : fallbackToggleMute()" disabled>
                    <i class="fas fa-microphone"></i>
                    Mute
                </button>
            </div>

            <div class="volume-section">
                <label for="volumeSlider">Volume:</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="80" onchange="adjustVolume(this.value)">
                <span id="volumeValue">80%</span>
            </div>

            <div class="incoming-call" id="incomingCall" style="display: none;">
                <div class="incoming-call-content">
                    <h3><i class="fas fa-phone-volume"></i> Incoming Call from Pizzeria</h3>
                    <div class="incoming-call-buttons">
                        <button class="btn btn-accept" onclick="window.acceptCall ? window.acceptCall() : fallbackAcceptCall()">
                            <i class="fas fa-phone"></i>
                            Accept
                        </button>
                        <button class="btn btn-decline" onclick="window.declineCall ? window.declineCall() : fallbackDeclineCall()">
                            <i class="fas fa-phone-slash"></i>
                            Decline
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-section">
            <h3>Call Logs</h3>
            <div class="call-logs" id="callLogs">
                <p class="no-logs">No recent calls</p>
            </div>
        </div>
    </div>

    <!-- Agora Web SDK -->
    <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N-4.19.0.js"></script>
    <script>
        // Set Agora configuration from server
        fetch('/api/config')
            .then(response => response.json())
            .then(config => {
                window.AGORA_APP_ID = config.agoraAppId;
                window.AGORA_CONFIG = config;
                console.log('Loaded Agora config:', config);
            })
            .catch(error => {
                console.error('Failed to load config:', error);
            });
    </script>
    <script src="js/agora-fallback.js"></script>
    <script src="js/agora-client.js"></script>
    <script>
        // Initialize the page as 'cucina'
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize fallback system
            window.fallbackVoiceCall.initialize('cucina');

            // Inizializza WebSocket per segnalazione chiamate
            const nomeAzienda = localStorage.getItem('nomeAzienda');
            if (nomeAzienda) {
                // Crea connessione WebSocket
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
                window.ws = new WebSocket(wsUrl);
                
                window.ws.onopen = function() {
                    console.log('ðŸ”— Cucina WebSocket connesso');
                    // Unisciti alla room dell'azienda
                    window.ws.send(JSON.stringify({ 
                        action: 'joinRoom', 
                        companyName: nomeAzienda 
                    }));
                    // Entra nella pagina cucina per chiamate
                    window.ws.send(JSON.stringify({ 
                        action: 'joinPage', 
                        pageType: 'cucina' 
                    }));

                    // Inizializza Agora dopo connessione WebSocket
                    setTimeout(() => {
                        initializeAgoraClient('cucina');
                    }, 500);
                };
                
                window.ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.action === 'connectionConfirmed') {
                        console.log('âœ… Cucina: Conferma connessione ricevuta:', data.message);
                    }
                    // Gestisci messaggi di segnalazione chiamate
                    else if (data.action === 'incoming-call' && data.to === 'cucina') {
                        console.log('ðŸ“ž Chiamata in arrivo per Cucina:', data);
                        if (window.showIncomingCall) {
                            window.showIncomingCall();
                        }
                    }
                    else if (data.action === 'call-accepted' || data.action === 'call-declined' || data.action === 'call-ended') {
                        console.log('ðŸ“ž Stato chiamata aggiornato:', data);
                    }
                };
                
                window.ws.onerror = function(error) {
                    console.error('âŒ Errore WebSocket Cucina:', error);
                };

                window.ws.onclose = function() {
                    console.log('ðŸ”Œ WebSocket Cucina disconnesso');
                };
            } else {
                console.warn('âš ï¸ Nome azienda non trovato, inizializzando Agora senza WebSocket');
                // Inizializza Agora anche senza WebSocket
                setTimeout(() => {
                    initializeAgoraClient('cucina');
                }, 500);
            }
        });
    </script>
</body>
</html>
