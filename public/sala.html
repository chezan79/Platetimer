
<!DOCTYPE html>
<html>
<head>
    <title>Sala</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .countdown-container {
            max-width: 800px;
            width: 100%;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 300;
        }
        
        .countdown-item {
            margin: 8px 0;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 50px;
        }

        .countdown-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .countdown-table {
            flex: 0 0 auto;
            margin-right: 15px;
        }

        .countdown-table h3 {
            margin: 0;
            color: #333;
            font-size: 22px;
            font-weight: 600;
            white-space: nowrap;
        }

        .countdown-time {
            flex: 1;
            text-align: center;
        }

        .countdown-time p {
            margin: 0;
            font-size: 22px;
            color: #d9534f;
            font-weight: bold;
        }
        
        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
    </style>
</head>
<body>
    <!-- Nome Azienda fuori dal container in alto a sinistra -->
    <div id="company-header" style="position: absolute; top: 20px; left: 20px; z-index: 1000; padding: 10px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border-left: 4px solid #ffc107;">
        <h4 id="company-name" style="margin: 0; color: #333; font-weight: 600;">Nome Azienda</h4>
    </div>
    
    <div class="countdown-container">
        <h1>üçΩÔ∏è Sala</h1>
        <div id="tavoli">
            <!-- I countdown sincronizzati appariranno qui -->
        </div>
        </div>

    <audio id="alertSound" src="alerte-346112.mp3" preload="auto"></audio>
    <audio id="zeroSound" src="costa-rica-eas-alarm-346194.mp3" preload="auto"></audio>
    
    <!-- Tasto Home in alto a destra -->
    <div style="position: absolute; top: 20px; right: 20px; z-index: 1000;">
        <button onclick="window.location.href='home.html'" style="padding: 6px 12px; background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; transition: transform 0.2s, box-shadow 0.2s;">üè† Home</button>
    </div>

    <script>
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
        const countdowns = [];

        // Sistema Chat Vocale
        let voiceChat = {
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            currentTarget: null,
            wakeWordRecognition: null,
            messageRecognition: null
        };

        ws.onopen = () => {
            // Unisciti alla room dell'azienda
            const companyName = localStorage.getItem('userCompany') || 'Nome Azienda';
            const joinMessage = {
                action: 'joinRoom',
                companyName: companyName
            };
            ws.send(JSON.stringify(joinMessage));
            console.log(`Sala connessa alla room: ${companyName}`);
        };

        // Inizializza chat vocale al caricamento
        document.addEventListener('DOMContentLoaded', () => {
            initVoiceChat();
        });

        function sortCountdowns() {
            countdowns.sort((a, b) => a.timeRemaining - b.timeRemaining);
            const container = document.getElementById('tavoli');
            container.innerHTML = '';
            countdowns.forEach(countdown => {
                container.appendChild(countdown.element);
            });
        }

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.action === 'startCountdown') {
                    startCountdown(data.tableNumber, data.timeRemaining);
                }
            } catch (error) {
                console.error('Errore nel parsing del messaggio:', error);
            }
        };

        function startCountdown(tableNumber, timeRemaining) {
            // Rimuovi il vecchio countdown se esiste
            const existingIndex = countdowns.findIndex(c => c.tableNumber == tableNumber);
            if (existingIndex !== -1) {
                clearInterval(countdowns[existingIndex].interval);
                if (countdowns[existingIndex].element && countdowns[existingIndex].element.parentNode) {
                    countdowns[existingIndex].element.parentNode.removeChild(countdowns[existingIndex].element);
                }
                countdowns.splice(existingIndex, 1);
                console.log(`üîÑ Countdown esistente per tavolo ${tableNumber} sostituito in sala`);
            }

            const countdownElement = document.createElement('div');
            countdownElement.id = `countdown-${tableNumber}`;
            countdownElement.classList.add('countdown-item');

            let remainingTime = parseInt(timeRemaining);

            const countdown = {
                tableNumber: tableNumber,
                timeRemaining: remainingTime,
                element: countdownElement,
                interval: null
            };
            countdown.interval = setInterval(() => {
                // Decrementa PRIMA come in cucina.html
                remainingTime--;
                countdown.timeRemaining = remainingTime;
                
                if (remainingTime <= 0) {
                    clearInterval(countdown.interval);
                    countdownElement.style.backgroundColor = '#ff4444';
                    countdownElement.innerHTML = `
                        <div class="countdown-table">
                            <h3>Tavolo ${tableNumber}</h3>
                        </div>
                        <div class="countdown-time">
                            <p>Tempo scaduto!</p>
                        </div>
                    `;
                    
                    // Riproduce il suono personalizzato per countdown a zero
                    const zeroAudio = document.getElementById('zeroSound');
                    if (zeroAudio) {
                        zeroAudio.play().catch(e => console.log('Errore audio countdown zero:', e));
                    }
                    
                    setTimeout(() => {
                        const index = countdowns.indexOf(countdown);
                        if (index > -1) {
                            countdowns.splice(index, 1);
                            sortCountdowns();
                        }
                    }, 45000);
                    return;
                }

                // Riordina ogni 5 secondi come in cucina.html
                if (remainingTime % 5 === 0) {
                    sortCountdowns();
                }

                if (remainingTime === 60) {
                    countdownElement.style.backgroundColor = '#ffeb3b';
                    const audio = document.getElementById('alertSound');
                    if (audio) audio.play().catch(e => console.log('Errore audio:', e));
                }

                countdownElement.innerHTML = `
                    <div class="countdown-table">
                        <h3>Tavolo ${tableNumber}</h3>
                    </div>
                    <div class="countdown-time">
                        <p>${formatTime(remainingTime)}</p>
                    </div>
                `;
            }, 1000);

            countdowns.push(countdown);
            sortCountdowns();
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function initVoiceChat() {
            // Crea pulsante chat vocale
            const chatButton = document.createElement('button');
            chatButton.id = 'voice-chat-button';
            chatButton.innerHTML = 'üí¨ Chat Vocale';
            chatButton.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 1000;
                padding: 10px 15px;
                background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
            `;
            
            // Status chat vocale
            const chatStatus = document.createElement('div');
            chatStatus.id = 'voice-chat-status';
            chatStatus.style.cssText = `
                position: fixed;
                top: 120px;
                right: 20px;
                z-index: 1000;
                padding: 8px 12px;
                background: rgba(0,0,0,0.8);
                color: white;
                border-radius: 5px;
                font-size: 12px;
                display: none;
                max-width: 200px;
                word-wrap: break-word;
            `;
            
            document.body.appendChild(chatButton);
            document.body.appendChild(chatStatus);
            
            chatButton.onclick = startVoiceChat;
            
            // Listener per messaggi chat vocale
            ws.addEventListener('message', handleVoiceChatMessage);
        }

        async function startVoiceChat() {
            const button = document.getElementById('voice-chat-button');
            const status = document.getElementById('voice-chat-status');
            
            if (voiceChat.isRecording) {
                stopVoiceChat();
                return;
            }
            
            try {
                // Richiedi permessi microfono
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                button.style.background = '#dc3545';
                button.innerHTML = 'üî¥ Ascoltando...';
                status.style.display = 'block';
                status.textContent = 'üé§ D√¨: "messaggio cucina", "messaggio pizzeria" o "messaggio insalata"';
                
                voiceChat.isRecording = true;
                
                // Avvia riconoscimento parola chiave
                startWakeWordRecognition();
                
            } catch (error) {
                console.error('Errore accesso microfono:', error);
                status.style.display = 'block';
                status.textContent = '‚ùå Errore: permessi microfono negati';
                status.style.background = 'rgba(220, 53, 69, 0.9)';
            }
        }

        function startWakeWordRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Riconoscimento vocale non supportato');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            voiceChat.wakeWordRecognition = new SpeechRecognition();
            
            voiceChat.wakeWordRecognition.lang = 'it-IT';
            voiceChat.wakeWordRecognition.continuous = true;
            voiceChat.wakeWordRecognition.interimResults = false;
            
            voiceChat.wakeWordRecognition.onresult = function(event) {
                const result = event.results[event.results.length - 1];
                const command = result[0].transcript.toLowerCase();
                
                console.log('üé§ Wake word riconosciuto:', command);
                
                // Controlla parola chiave + destinatario
                if (command.includes('messaggio')) {
                    let target = null;
                    if (command.includes('cucina')) {
                        target = 'cucina';
                    } else if (command.includes('pizzeria')) {
                        target = 'pizzeria';
                    } else if (command.includes('insalata')) {
                        target = 'insalata';
                    }
                    
                    if (target) {
                        voiceChat.currentTarget = target;
                        voiceChat.wakeWordRecognition.stop();
                        startMessageRecording();
                    } else {
                        const status = document.getElementById('voice-chat-status');
                        status.textContent = '‚ö†Ô∏è Specifica destinatario: "messaggio cucina", "messaggio pizzeria" o "messaggio insalata"';
                    }
                }
            };
            
            voiceChat.wakeWordRecognition.onerror = function(event) {
                console.error('Errore wake word:', event.error);
            };
            
            voiceChat.wakeWordRecognition.start();
        }

        async function startMessageRecording() {
            const status = document.getElementById('voice-chat-status');
            status.textContent = `üé§ Registrando messaggio per ${voiceChat.currentTarget.toUpperCase()}...`;
            status.style.background = 'rgba(40, 167, 69, 0.9)';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceChat.mediaRecorder = new MediaRecorder(stream);
                voiceChat.audioChunks = [];
                
                voiceChat.mediaRecorder.ondataavailable = function(event) {
                    voiceChat.audioChunks.push(event.data);
                };
                
                voiceChat.mediaRecorder.onstop = function() {
                    sendVoiceMessage();
                    stream.getTracks().forEach(track => track.stop());
                };
                
                voiceChat.mediaRecorder.start();
                
                // Registra per 5 secondi
                setTimeout(() => {
                    if (voiceChat.mediaRecorder && voiceChat.mediaRecorder.state === 'recording') {
                        voiceChat.mediaRecorder.stop();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('Errore registrazione:', error);
                status.textContent = '‚ùå Errore registrazione';
                status.style.background = 'rgba(220, 53, 69, 0.9)';
                stopVoiceChat();
            }
        }

        function sendVoiceMessage() {
            const status = document.getElementById('voice-chat-status');
            status.textContent = `üì§ Inviando messaggio a ${voiceChat.currentTarget.toUpperCase()}...`;
            
            const audioBlob = new Blob(voiceChat.audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            
            reader.onload = function() {
                const audioData = reader.result;
                
                // Invia messaggio vocale via WebSocket
                const message = {
                    action: 'voiceMessage',
                    from: 'sala',
                    to: voiceChat.currentTarget,
                    audioData: audioData,
                    timestamp: Date.now()
                };
                
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(message));
                    status.textContent = `‚úÖ Messaggio inviato a ${voiceChat.currentTarget.toUpperCase()}`;
                    status.style.background = 'rgba(40, 167, 69, 0.9)';
                } else {
                    status.textContent = '‚ùå Errore connessione WebSocket';
                    status.style.background = 'rgba(220, 53, 69, 0.9)';
                }
                
                setTimeout(() => {
                    stopVoiceChat();
                }, 2000);
            };
            
            reader.readAsDataURL(audioBlob);
        }

        function stopVoiceChat() {
            const button = document.getElementById('voice-chat-button');
            const status = document.getElementById('voice-chat-status');
            
            if (voiceChat.wakeWordRecognition) {
                voiceChat.wakeWordRecognition.stop();
                voiceChat.wakeWordRecognition = null;
            }
            
            if (voiceChat.mediaRecorder && voiceChat.mediaRecorder.state !== 'inactive') {
                voiceChat.mediaRecorder.stop();
            }
            
            voiceChat.isRecording = false;
            voiceChat.currentTarget = null;
            voiceChat.audioChunks = [];
            
            button.style.background = 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)';
            button.innerHTML = 'üí¨ Chat Vocale';
            status.style.display = 'none';
            status.style.background = 'rgba(0,0,0,0.8)';
        }

        function handleVoiceChatMessage(event) {
            try {
                const data = JSON.parse(event.data);
                
                if (data.action === 'voiceMessage' && data.to === 'sala') {
                    console.log(`üé§ Messaggio vocale ricevuto da ${data.from.toUpperCase()}`);
                    
                    // Mostra notifica
                    showVoiceNotification(data.from);
                    
                    // Riproduci il messaggio audio
                    playReceivedVoiceMessage(data.audioData);
                }
            } catch (error) {
                console.error('Errore gestione messaggio vocale:', error);
            }
        }

        function showVoiceNotification(from) {
            // Crea notifica temporanea
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 2000;
                font-weight: 600;
                font-size: 16px;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `üé§ Messaggio da ${from.toUpperCase()}`;
            
            // Aggiungi animazione CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Rimuovi dopo 3 secondi
            setTimeout(() => {
                notification.remove();
                style.remove();
            }, 3000);
        }

        function playReceivedVoiceMessage(audioData) {
            try {
                const audio = new Audio(audioData);
                audio.volume = 0.8;
                audio.play().catch(e => console.log('Errore riproduzione audio:', e));
            } catch (error) {
                console.error('Errore creazione audio:', error);
            }
        }
    </script>
    <script src="company-header.js"></script>
</body>
</html>
